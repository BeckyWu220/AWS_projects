# Data Processing - AWS Glue Crawler & ETL Job
### Objectives:
Use Glue crawler to scan data in S3, infer data schema.



### Note about Source Data:

Subset of NOAA Global Surface Summary of Day dataset - collection of daily weather measurements including temperature, wind speed, humidity, pressure from 9k+ weather stations around the world. [Sample data](attachments/sample.csv) attached.

### Important Steps
1. Create a Glue crawler to scan the data in S3, infer the schema of the data, and filter data that will be included in the Data Catalog.
    
    ![Add crawler](attachments/crawler-1_1.png)
    
    ![Add S3 data source](attachments/crawler-1_2.png)
    
    ![Exclude file matching pattern](attachments/crawler-1_3.png)
    
   * Note: The given source data S3 buckets contains many subfolders, named with year. Files matching the specified pattern would be skipped. In this example, we are skipping all data created for 19 century, 200* year,  2010~2012 year, which leaves weather data from 2013 to 2022.*

	* Add a Glue Database and set it as Target database while creating the crawler.
    
    	![Create a Glue Database](attachments/glue-database-1_1.png)
    
    	![Select the Glue Database created, “weather_data”, as output, i.e Target database, of Glue Crawler.](attachments/crawler-1_4.png)

2. Run Crawler to build a Data Catalog table using the data in S3. 
    
    ![Crawler created and Run Crawler](attachments/crawler-1_5.png)
 
    ![Wait for Crawler to finish running](attachments/crawler-1_6.png)
    
3. View the table in Glue Data Catalog
    
   Once Glue Crawler finishes running, a new table is created in the Glue Database, “weather_data”. The table is named “data”, and the classification for the data is .csv, which is inferred by Glue when it read data from source S3.](attachments/Untitled%2010.png)
    
  * View properties of the table
    
    ![Table Properties
    ](attachments/glue-table-1_1.png)
    
    ![Table Properties](attachments/glue-table-1_2.png)
    
    ![In "StorageDescriptor" field, column name and type are inferred.](attachments/glue-table-1_3.png)
    
    
  * [Optional] View data using Athena query.
    
    ![Athena query](attachments/athena-1_1.png)
    From the results table, you know that many fields are in fact empty. Therefore, we need to run a Glue job to clean up the data. 
    
    ![Empty fields in Athena query results](attachments/athena-1_2.png)
    
4. Create and run a Glue ETL job to cleanup data
	The cleanup includes field renaming, field type change and remove empty fields. We are using Visual ETL to create the job.
	
	* Create a Visual ETL
    ![Create a Visual ETL](attachments/glue-job-1_1.png)
    
   * Add a "Source" node and edit node properties to make Data Catalog table the source.            
    ![Add a "Source" node](attachments/glue-job-1_2.png)       
    ![Edit node properties.](attachments/glue-job-1_3.png)
            
	* Add "Transforms" node of "Change Schema" type.
    ![Add "Transforms" node of "Change Schema" type.](attachments/glue-job-1_4.png)
            
    ![Toggle columns to drop & Change field type](attachments/glue-job-1_5.png)
    ![Rename field](attachments/glue-job-1_6.png)
            
   * Add "Target" node with "S3" type.
    ![Add "Target" node with "S3" type](attachments/glue-job-1_7.png)
    ![Store as ".parquet" format in target S3](attachments/glue-job-1_8.png)
    ![Create a new table in Glue database, “data_parquet” and use “report_data” as partition key. ](attachments/glue-job-1_9.png)
            
   * Preview the script auto-generated by Glue
   	![Auto-generated script](attachments/glue-job-1_10.png)
   	 Note: the field renaming, “date”→”report_date”, and field type change, from “string”→”date” for the “date” field, and all the dropped columns are not listed here.This script will be saved to S3 as well. 

5. Run the ELT job.
   ![Run the ELT job](attachments/glue-job-1_11.png)
        
6. Query the Glue Data Catalog using Athena.
    
    ![Query the Glue Data Catalog using Athena](attachments/athena-2_1.png)
    
    ![Athena Query Result](attachments/athena-2_2.png)
    
    [28f756b9-00ff-4cf0-98d3-120110b9958e.csv](attachments/28f756b9-00ff-4cf0-98d3-120110b9958e.csv)
    
7. View processed data in target S3.
   ![View processed data in target S3](attachments/s3-1_1.png)
  	![Open one of the .parquet file with Parquet viewer](attachments/s3-1_2.png)